<% layout('layout') %>
<div class="card">
  <h2><%= t ? t('questions.title') : 'Daily Questions' %></h2>
  <p class="muted"><%= t ? t('questions.today', { n: (typeof todayDay !== 'undefined' ? todayDay : maxDay) }) : `Today's day: ${typeof todayDay !== 'undefined' ? todayDay : maxDay}` %></p>

  <!-- Ð’ÐµÑ€Ñ…Ð½ÑÑ ÐºÐ°Ñ€Ñ‚Ð¾Ñ‡ÐºÐ° Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ (Ð¸Ð»Ð¸ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ð¾Ð³Ð¾) Ð´Ð½Ñ -->
  <% if (selected) { %>
  <div class="callout">
    <div class="callout-head">
      <h3 style="margin:0;"><%= t ? t('questions.day', { n: selected.day }) : `Day ${selected.day}` %></h3>
      <div class="chips">
  <% if (!user) { %>
    <span class="chip info"><%= t ? t('questions.signInToAnswer') : 'Sign in to answer' %></span>
  <% } else if (attempted) { %>
    <% if (alreadyCorrect) { %>
      <span class="chip ok"><%= t ? t('questions.completed') : 'Completed' %></span>
    <% } else { %>
      <span class="chip warn"><%= t ? t('questions.attemptUsed') : 'Attempt used' %></span>
    <% } %>
  <% } else { %>
    <span class="chip info"><%= t ? t('questions.oneAttemptOnly') : 'One attempt' %></span>
  <% } %>
</div>
    </div>

    <% if (toast) { %><div class="toast <%= toast.type %>"><%= toast.text %></div><% } %>

    <% 
      // Ð¢ÐµÐºÑÑ‚ Ð¸ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ñ‹ Ð¸Ð· i18n; Ñ„Ð¾Ð»Ð±ÑÐº â€” Ð°Ñ€Ð¸Ñ„Ð¼ÐµÑ‚Ð¸ÐºÐ° ÐºÐ°Ðº Ñ€Ð°Ð½ÑŒÑˆÐµ
      const keyBase = qKey || ('q.' + selected.day);
      const qText = t ? t(keyBase + '.text') : ('How much is ' + selected.day + ' + ' + selected.day + '?');
      let opts = t ? t(keyBase + '.options', { returnObjects: true }) : null;
      if (!Array.isArray(opts) || opts.length !== 4) {
        // fallbackOptions ÑÐµÑ€Ð²ÐµÑ€ ÑƒÐ¶Ðµ Ð¿ÐµÑ€ÐµÐ´Ð°Ñ‘Ñ‚
        opts = (fallbackOptions && fallbackOptions.length === 4) 
          ? fallbackOptions 
          : [ (selected.day*2 - 1) + '', (selected.day*2) + '', (selected.day*2 + 1) + '', (selected.day*2 + 2) + '' ];
      }
    %>

    <p style="margin:8px 0 14px;"><%= qText %></p>

    <% if (!user) { %>
<div class="toast warn">
  <%= t ? t('questions.loginToAnswer') : 'Please log in to submit an answer.' %>
  <a href="/login"><%= t ? t('nav.login') : 'Log in' %></a> <%= t ? t('common.or') : 'or' %>
  <a href="/register"><%= t ? t('nav.register') : 'Register' %></a>.
</div>

    <% } else if (!attempted) { %>
      <form method="post" action="/questions/submit" style="max-width:480px;">
        <input type="hidden" name="day" value="<%= selected.day %>" />
        <fieldset style="border:none; padding:0; margin:0 0 10px;">
          <% opts.forEach((opt, i) => { %>
            <label style="display:flex; gap:8px; align-items:center; padding:8px 10px; border:1px solid #2b415b; border-radius:10px; margin-bottom:8px; background:#0f2336;">
              <input type="radio" name="choice" value="<%= i %>" required />
              <span><%= opt %></span>
            </label>
          <% }) %>
        </fieldset>
        <button class="btn">Submit</button>
      </form>

<% } else { %>
  <% if (alreadyCorrect) { %>
    <div class="toast ok"><%= t ? t('questions.alreadyAnswered') : 'Answer already counted! ðŸŽ‰' %></div>
  <% } else { %>
    <div class="toast warn"><%= t ? t('questions.alreadySubmitted') : 'You have already submitted an answer for this day. Only one attempt is allowed.' %></div>
  <% } %>
<% } %>
<% } else if (dayParam) { %>
  <div class="toast warn"><%= t ? t('questions.notAvailable') : 'This day is not available or not found.' %></div>
<% } %>

  <!-- Ð¡ÐµÑ‚ÐºÐ° Ð´Ð½ÐµÐ¹ ÑÐ¾ ÑÑ‚Ð°Ñ‚ÑƒÑÐ°Ð¼Ð¸ -->
  <div class="grid" style="margin: 16px 0 6px;">
    <% const _todayDay = typeof todayDay !== 'undefined' ? todayDay : maxDay; %>
    <% for (let d = 1; d <= 25; d++) { %>
      <% const locked = d > maxDay; const isToday = (_todayDay && d === _todayDay); const st = (statusByDay && statusByDay[d]) || {attempted:false, correct:false}; %>
<div class="day <%= locked ? 'locked' : '' %> <%= isToday ? 'highlighted' : '' %>">
        <% if (!locked) { %>
          <a class="legacy-pill" href="/questions?day=<%= d %>">
            <%= t ? t('questions.day', { n: d }) : `Day ${d}` %>
            <% if (st.attempted) { %>
              <% if (st.correct) { %> âœ… <% } else { %> âœ– <% } %>
            <% } %>
          </a>
        <% } else { %>
          <span class="legacy-pill"><%= t ? t('questions.day', { n: d }) : `Day ${d}` %> ðŸ”’</span>
        <% } %>
      </div>
    <% } %>
  </div>
</div>

<style>
  .callout { border:1px solid #29455f; border-radius:12px; padding:14px; margin:10px 0 14px; background:#0f2236; }
  .callout-head { display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
  .chips { display:flex; gap:6px; }
  .chip { display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid #35506b; background:#0e2032; color:#eaf4ff; }
  .chip.ok { border-color:#2ecc71; }
  .chip.warn { border-color:#f1c40f; }
  .chip.info { border-color:#4f6d8c; }
</style>
